# create source environment
FROM microsoft/dotnet:2.1-sdk AS source
WORKDIR /src
# copy in the required projects and restore
COPY /src/DemoCluster.DAL ./DemoCluster.DAL
COPY /src/DemoCluster.GrainImplementations ./DemoCluster.GrainImplementations
COPY /src/DemoCluster.GrainInterfaces ./DemoCluster.GrainInterfaces
COPY /src/DemoCluster.Util ./DemoCluster.Util
COPY /src/Orleans.Storage.Redis ./Orleans.Storage.Redis
COPY /src/DemoCluster ./DemoCluster
WORKDIR ./DemoCluster
RUN dotnet restore -v m ./DemoCluster.csproj

# create a build environment from source
FROM source AS build
RUN dotnet build -v m .

# take the build and publish the app
FROM build AS publish
RUN dotnet publish -c Release -o ../../release

# now create the runtime image
FROM microsoft/dotnet:2.1-runtime AS runtime
WORKDIR /silo
COPY --from=publish /release .
# dashboard monitor port
EXPOSE 8080
# default silo to silo port
EXPOSE 11111
# default gateway port
EXPOSE 30000
ENTRYPOINT [ "dotnet", "DemoCluster.dll" ]